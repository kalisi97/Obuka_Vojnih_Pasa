@model Obuka_Vojnih_Pasa.ViewModels.ZadatakViewModel.UnosZadatkaViewModel

@{
    ViewData["Title"] = "Create";
}

    <body>


        <div class="edit" style="background:none">
            <div class="container">
                <div class="row main">


                    <table id="multipleCategoryTbl2" class="table" style="margin-top:50px">


                        <thead class="multipleCategoryTbl-header">
                            <tr>
                                <td>

                                    <div class="form-group">
                                        <label class="cols-sm-2 control-label">Naziv zadatka</label>
                                        <div class="cols-sm-10">
                                            <div class="input-group">
                                                <span class="input-group-addon"><i class="fa fa-rocket fa" aria-hidden="true"></i></span>
                                                <input asp-for="NazivZadatka" class="form-control" id="txtZadatak" />
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td style="width:300px">
                                    <div class="form-group">
                                        <label class="cols-sm-2 control-label">Datum</label>
                                        <div class="cols-sm-10">
                                            <div class="input-group">
                                                <span class="input-group-addon"><i class="fa fa-calendar-alt fa" aria-hidden="true"></i></span>
                                                <input asp-for="Datum" class="form-control" id="txtDatum" />
                                                <span asp-validation-for="Datum" class="text-danger"></span>
                                            </div>
                                        </div>
                                    </div>
                                </td>


                                <td>
                                    <div class="form-group">
                                        <label class="cols-sm-2 control-label">Naziv terena</label>
                                        <div class="cols-sm-10">
                                            <div class="input-group">
                                                <span class="input-group-addon"><i class="fa fa-map-marked-alt" aria-hidden="true"></i></span>

                                                <input asp-for="Teren" class="form-control" id="txtTeren" />
                                                <span asp-validation-for="Teren" class="text-danger"></span>


                                            </div>
                                        </div>
                                    </div>

                                </td>


                        </thead>


                    </table>





                    <div class="table-borderless" id="tbl">

                        <table id="multipleCategoryTbl" class="table" style="margin-top:50px">


                            <thead class="multipleCategoryTbl-header">
                                <tr>
                                    <td>

                                        <div class="form-group">

                                            <label asp-for="Ime" class="control-label"> <i class="fas fa-paw"></i> Pas</label>
                                            <select asp-for="PasId" id="pas" class="form-control" asp-items="ViewBag.PasId"></select>

                                            <span asp-validation-for="PasId" class="text-danger" />

                                        </div>
                                    </td>


                                    <td>
                                        <div class="form-group">
                                            <input type="button" id="btnAdd" value="Dodaj" class="btn btnPsi btn-primary" style="margin-top:25px" />
                                        </div>

                                    </td>
                            </thead>

                            <tbody class="multipleCategoryTbl-body">
                            </tbody>


                        </table>
                    </div>


                </div>
            </div>
        </div>


        <div class="form-group" style="margin-left:60px">
            <input type="button" id="btnSave" value="Sačuvaj" class="btn btnPsi btn-primary ml-3" />
        </div>

        <script type="text/javascript">
            $("body").on("click", "#btnAdd", function () {
                var validate = true;
                var txtPas = $("#pas option:selected");
                var txtZadatak = $("#txtZadatak");
                var txtDatum = $("#txtDatum");
                var txtTeren = $("#txtTeren");
                var tBody = $("#multipleCategoryTbl > TBODY")[0];
              
                $("#multipleCategoryTbl TBODY TR").each(function () {
                    var row = $(this);
                    var txtTrenutni = row.find("TD").eq(1).html();


                    if (txtPas.val() == txtTrenutni) {
                        validate = false;
                    }



                });
                if (!validate) {
                    Swal.fire({

                        icon: 'error',
                        title: "Nevalidan unos! Angažovanje za psa je već uneto!"


                    });
                }
                else {

                var row = tBody.insertRow(-1);
                var cell = $(row.insertCell(-1));
                cell.html(txtPas.text());
                var cell = $(row.insertCell(-1));
                cell.html(txtPas.val()).css("display", "none");
                cell = $(row.insertCell(-1));
                var btnRemove = $("<input />");
                btnRemove.attr("type", "button").css("background", "linear-gradient(to right, #6dd5ed, #2193b0)").css("border-radius", "100px").css("color", "white").css("width", "80px").css("border-color", "silver");
                btnRemove.attr("onclick", "Remove(this);");
                btnRemove.val("Obriši");
                cell.append(btnRemove);

            }


            });
            function Remove(button) {
                var row = $(button).closest("TR");
                var name = $("TD", row).eq(0).html();

                Swal.fire({
                    title: "Da li ste sigurni da želite da obrišete podatke o psu " + name + "?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    cancelButtonText: 'Otkaži',
                    confirmButtonText: 'Obriši'
                }).then((result) => {
                    if (result.value) {
                        var table = $("#multipleCategoryTbl")[0];
                        table.deleteRow(row[0].rowIndex);
                        Swal.fire(
                            'Obrisano!'
                        )
                    }
                });


            };


            $("body").on("click", "#btnSave", function () {
            
                var i = 0;
                var validate = true;
                if (txtTeren.value === "") validate = false;
                if (txtZadatak.value === "") validate = false;
                if (txtDatum.value === "") validate = false;
                $("#multipleCategoryTbl TBODY TR").each(function () {
                    i++;
                });
                if (i === 0) validate = false;
                if (!validate) {
                   
                    Swal.fire({

                        icon: 'error',
                        title: "Nevalidan unos! Proverite da li ste popunili sve podatke o zadatku i uneli angažovane pse!"


                    });
                  
                } else {


                    var zadatak = new Object();
                    var z = {};
                    z.NazivZadatka = txtZadatak.value;
                    z.Datum = txtDatum.value;
                    z.Teren = txtTeren.value;

                    zadatak = z;

                    var angazovanja = new Array();

                    $("#multipleCategoryTbl TBODY TR").each(function () {

                        var row = $(this);
                        var a = {};

                        a.PasId = row.find("TD").eq(1).html();
                        a.Ocena = null;
                        a.DatumUnosaOcene = null;
                        angazovanja.push(a);
                    });

                    zadatak.Angazovanja = angazovanja;

                    $.ajax({
                        type: "POST",
                        url: "/Zadatak/InsertZadatak",
                        data: JSON.stringify(zadatak),
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (r) {


                            Swal.fire({
                                icon: 'success',
                                title: " " + r + " "

                            }).then(function () {

                                window.location.replace('/Zadatak/Index');
                            });
                            $("#multipleCategoryTbl TBODY TR").each(function () {
                                $(this).remove();

                            });

                        }
                    });
                }
            });

        </script>
        <script src="https://cdn.jsdelivr.net/npm/promise-polyfill"></script>
        <script src="~/sweetalert2/dist/sweetalert2.all.min.js"></script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script type="text/javascript" src="http://ajax.cdnjs.com/ajax/libs/json2/20110223/json2.js"></script>
        <link href="~/content/site.css" rel="stylesheet" />
    </body>